(this.webpackJsonpdrawable_canvas=this.webpackJsonpdrawable_canvas||[]).push([[0],{19:function(t,e){},20:function(t,e){},21:function(t,e){},23:function(t,e,s){},24:function(t,e,s){"use strict";s.r(e);var i=s(0),o=s.n(i),a=s(7),n=s.n(a),r=s(3),c=s(1),l=s(2),h=s(4),u=s.n(h),d="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAAwwAAAMMBnc7+MwAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAEFSURBVEiJ7dSxLkRBFMbx31BIlkQlHoCap5BQLAXvQafV6DyLRLYSdkWv0dBQ0NAKkUhkj2bEzc3udW9xE5E9yVfNd85/5pyZSRGhzZhqtfoE8DcAKaVOqwD0mkBSSnNNAAmBAboR8V4qtoguVrNWMI9n3Gad4SQqHlRk9dHJvmns4qWwXqUrbESEspSMfazhekyhN9zhc8z6KWarAKN0jm0sI+WkmdyuPTyV/JdFSBXgATujjl3aYQf7+CjkXhTaPRYw+DbVETZLkMM6Leo3hGxhmHNfsVBnBk0hx4XcozqARpA8/GG+bQcJ6+rFTUQ81jGmlJYi4p6fa9da/IPvegL4Lb4A0uc9nRaYXwcAAAAASUVORK5CYII=";const f=t=>{let{imgUrl:e,altText:s,invertX:i,size:a,enabled:n,clickCallback:r}=t;return o.a.createElement("img",{src:e,className:"\n    ".concat(n?u.a.enabled:u.a.disabled," ").concat(i?"":u.a.invertx,"\n    "),alt:s,title:s,height:"".concat(a,"px"),width:"".concat(a,"px"),onClick:r})};f.defaultProps={invertX:!1};var v=t=>{let{topPosition:e,leftPosition:s,canUndo:i,canRedo:a,downloadCallback:n,undoCallback:r,redoCallback:c,resetCallback:l}=t;const h=[{imgUrl:d,altText:"Undo",invertX:!0,enabled:i,clickCallback:i?r:()=>{}},{imgUrl:d,altText:"Redo",invertX:!1,enabled:a,clickCallback:a?c:()=>{}}];return o.a.createElement("div",{style:{position:"absolute",top:e+4,left:0,display:"flex",gap:4,zIndex:20}},h.map((t=>o.a.createElement(f,{key:t.altText,imgUrl:t.imgUrl,altText:t.altText,invertX:t.invertX,size:24,enabled:t.enabled,clickCallback:t.clickCallback}))))};var S=t=>{const[e,s]=Object(i.useState)(new c.fabric.Canvas("")),a=((t,e)=>{const[s,o]=Object(i.useState)(t);return Object(i.useEffect)((()=>{const s=setTimeout((()=>{o(t)}),e);return()=>{clearTimeout(s)}}),[t,e]),s})(t.stateToSendToStreamlit,200);return Object(i.useEffect)((()=>{const t=new c.fabric.Canvas("canvas-to-streamlit",{enableRetinaScaling:!1});s(t)}),[]),Object(i.useEffect)((()=>{a&&t.shouldSendToStreamlit&&e.loadFromJSON(a,(()=>{(t=>{const e=t.getContext().canvas.toDataURL();r.a.setComponentValue({data:e,width:t.getWidth(),height:t.getHeight(),raw:t.toObject()})})(e)}))}),[e,t.shouldSendToStreamlit,a]),o.a.createElement("canvas",{id:"canvas-to-streamlit",width:t.canvasWidth,height:t.canvasHeight})};const m={shouldReloadCanvas:!1,forceSendToStreamlit:!1},k={shouldReloadCanvas:!0,forceSendToStreamlit:!1},b={shouldReloadCanvas:!1,forceSendToStreamlit:!0},g={shouldReloadCanvas:!0,forceSendToStreamlit:!0},C=(t,e)=>{switch(e.type){case"save":if(e.state){if(Object(l.isEmpty)(t.currentState))return{history:{undoStack:[],redoStack:[]},action:{...m},initialState:e.state,currentState:e.state};if(Object(l.isEqual)(e.state,t.currentState))return{history:{...t.history},action:{...m},initialState:t.initialState,currentState:t.currentState};{const s=t.history.undoStack.length>=100;return{history:{undoStack:[...t.history.undoStack.slice(s?1:0),t.currentState],redoStack:[]},action:{...m},initialState:null==t.initialState?t.currentState:t.initialState,currentState:e.state}}}throw new Error("No action state to save");case"undo":if(Object(l.isEmpty)(t.currentState)||Object(l.isEqual)(t.initialState,t.currentState))return{history:{...t.history},action:{...m},initialState:t.initialState,currentState:t.currentState};{const e=0===t.history.undoStack.length;return{history:{undoStack:t.history.undoStack.slice(0,-1),redoStack:[...t.history.redoStack,t.currentState]},action:{...k},initialState:t.initialState,currentState:e?t.currentState:t.history.undoStack[t.history.undoStack.length-1]}}case"redo":return t.history.redoStack.length>0?{history:{undoStack:[...t.history.undoStack,t.currentState],redoStack:t.history.redoStack.slice(0,-1)},action:{...k},initialState:t.initialState,currentState:t.history.redoStack[t.history.redoStack.length-1]}:{history:{...t.history},action:{...m},initialState:t.initialState,currentState:t.currentState};case"reset":if(!e.state)throw new Error("No action state to store in reset");return{history:{undoStack:[],redoStack:[]},action:{...g},initialState:e.state,currentState:e.state};case"forceSendToStreamlit":return{history:{...t.history},action:{...b},initialState:t.initialState,currentState:t.currentState};default:throw new Error("TS should protect from this")}},w={history:{undoStack:[],redoStack:[]},action:{forceSendToStreamlit:!1,shouldReloadCanvas:!1},initialState:{},currentState:{}},M=Object(i.createContext)({}),_=t=>{let{children:e}=t;const[s,a]=Object(i.useReducer)(C,w),n=Object(i.useCallback)((t=>a({type:"save",state:t})),[a]),r=Object(i.useCallback)((()=>a({type:"undo"})),[a]),c=Object(i.useCallback)((()=>a({type:"redo"})),[a]),l=Object(i.useCallback)((()=>a({type:"forceSendToStreamlit"})),[a]),h=Object(i.useCallback)((t=>a({type:"reset",state:t})),[a]),u=0!==s.history.undoStack.length,d=0!==s.history.redoStack.length;return o.a.createElement(M.Provider,{value:{canvasState:s,saveState:n,undo:r,redo:c,canUndo:u,canRedo:d,forceStreamlitUpdate:l,resetState:h}},e)};var p=class{constructor(t){this._canvas=void 0,this._canvas=t}};var y=class extends p{constructor(){super(...arguments),this.isMouseDown=!1,this.fillColor="#ffffff",this.strokeWidth=10,this.strokeColor="#ffffff",this.currentCircle=new c.fabric.Circle,this.currentStartX=0,this.currentStartY=0,this._minRadius=10,this.linearDistance=(t,e)=>{let s=e.x-t.x,i=e.y-t.y;return Math.sqrt(s*s+i*i)}}configureCanvas(t){let{strokeWidth:e,strokeColor:s,fillColor:i}=t;return this._canvas.isDrawingMode=!1,this._canvas.selection=!1,this._canvas.forEachObject((t=>t.selectable=t.evented=!1)),this.strokeWidth=e,this.strokeColor=s,this.fillColor=i,this._minRadius=e,this._canvas.on("mouse:down",(t=>this.onMouseDown(t))),this._canvas.on("mouse:move",(t=>this.onMouseMove(t))),this._canvas.on("mouse:up",(t=>this.onMouseUp(t))),this._canvas.on("mouse:out",(t=>this.onMouseOut(t))),()=>{this._canvas.off("mouse:down"),this._canvas.off("mouse:move"),this._canvas.off("mouse:up"),this._canvas.off("mouse:out")}}onMouseDown(t){let e=this._canvas,s=t.e.button;this.isMouseDown=!0;let i=e.getPointer(t.e);this.currentStartX=i.x,this.currentStartY=i.y,this.currentCircle=new c.fabric.Circle({left:this.currentStartX,top:this.currentStartY,originX:"left",originY:"center",strokeWidth:this.strokeWidth,stroke:this.strokeColor,fill:this.fillColor,selectable:!1,evented:!1,radius:this._minRadius}),0===s&&e.add(this.currentCircle)}onMouseMove(t){if(!this.isMouseDown)return;let e=this._canvas,s=e.getPointer(t.e),i=this.linearDistance({x:this.currentStartX,y:this.currentStartY},{x:s.x,y:s.y})/2;this.currentCircle.set({radius:Math.max(i,this._minRadius),angle:180*Math.atan2(s.y-this.currentStartY,s.x-this.currentStartX)/Math.PI}),this.currentCircle.setCoords(),e.renderAll()}onMouseUp(t){this.isMouseDown=!1}onMouseOut(t){this.isMouseDown=!1}};var A=class extends p{configureCanvas(t){let{strokeWidth:e,strokeColor:s}=t;return this._canvas.isDrawingMode=!0,this._canvas.freeDrawingBrush.width=e,this._canvas.freeDrawingBrush.color=s,()=>{}}};var x=class extends p{constructor(){super(...arguments),this.isMouseDown=!1,this.strokeWidth=10,this.strokeColor="#ffffff",this.currentLine=new c.fabric.Line}configureCanvas(t){let{strokeWidth:e,strokeColor:s}=t;return this._canvas.isDrawingMode=!1,this._canvas.selection=!1,this._canvas.forEachObject((t=>t.selectable=t.evented=!1)),this.strokeWidth=e,this.strokeColor=s,this._canvas.on("mouse:down",(t=>this.onMouseDown(t))),this._canvas.on("mouse:move",(t=>this.onMouseMove(t))),this._canvas.on("mouse:up",(t=>this.onMouseUp(t))),this._canvas.on("mouse:out",(t=>this.onMouseOut(t))),()=>{this._canvas.off("mouse:down"),this._canvas.off("mouse:move"),this._canvas.off("mouse:up"),this._canvas.off("mouse:out")}}onMouseDown(t){let e=this._canvas,s=t.e.button;this.isMouseDown=!0;var i=e.getPointer(t.e),o=[i.x,i.y,i.x,i.y];this.currentLine=new c.fabric.Line(o,{strokeWidth:this.strokeWidth,fill:this.strokeColor,stroke:this.strokeColor,originX:"center",originY:"center",selectable:!1,evented:!1}),0===s&&e.add(this.currentLine)}onMouseMove(t){if(!this.isMouseDown)return;let e=this._canvas;var s=e.getPointer(t.e);this.currentLine.set({x2:s.x,y2:s.y}),this.currentLine.setCoords(),e.renderAll()}onMouseUp(t){this.isMouseDown=!1;let e=this._canvas;0===this.currentLine.width&&0===this.currentLine.height&&e.remove(this.currentLine)}onMouseOut(t){this.isMouseDown=!1}};var D=class extends p{constructor(){super(...arguments),this.isMouseDown=!1,this.fillColor="#ffffff",this.strokeWidth=10,this.strokeColor="#ffffff",this.startCircle=new c.fabric.Circle,this.currentLine=new c.fabric.Line,this.currentPath=new c.fabric.Path,this._pathString="M "}configureCanvas(t){let{strokeWidth:e,strokeColor:s,fillColor:i}=t;return this._canvas.isDrawingMode=!1,this._canvas.selection=!1,this._canvas.forEachObject((t=>t.selectable=t.evented=!1)),this.strokeWidth=e,this.strokeColor=s,this.fillColor=i,this._canvas.on("mouse:down",(t=>this.onMouseDown(t))),this._canvas.on("mouse:move",(t=>this.onMouseMove(t))),this._canvas.on("mouse:up",(t=>this.onMouseUp(t))),this._canvas.on("mouse:out",(t=>this.onMouseOut(t))),this._canvas.on("mouse:dblclick",(t=>this.onMouseDoubleClick(t))),()=>{this._canvas.off("mouse:down"),this._canvas.off("mouse:move"),this._canvas.off("mouse:up"),this._canvas.off("mouse:out"),this._canvas.off("mouse:dblclick")}}onMouseDown(t){let e=this._canvas,s=t.e.button,i=!1;"M "===this._pathString&&(i=!0),this.isMouseDown=!0;var o=e.getPointer(t.e),a=[o.x,o.y,o.x,o.y];e.remove(this.currentLine),this.currentLine=new c.fabric.Line(a,{strokeWidth:this.strokeWidth,fill:this.strokeColor,stroke:this.strokeColor,originX:"center",originY:"center",selectable:!1,evented:!1}),0===s&&e.add(this.currentLine),i&&0===s?(this._pathString+="".concat(o.x," ").concat(o.y," "),this.startCircle=new c.fabric.Circle({left:o.x,top:o.y,originX:"center",originY:"center",strokeWidth:this.strokeWidth,stroke:this.strokeColor,fill:this.strokeColor,selectable:!1,evented:!1,radius:this.strokeWidth}),e.add(this.startCircle),i=!1):(e.remove(this.currentPath),0===s&&(this._pathString+="L ".concat(o.x," ").concat(o.y," ")),2===s&&(this._pathString+="z",e.remove(this.startCircle))),this.currentPath=new c.fabric.Path(this._pathString,{strokeWidth:this.strokeWidth,fill:this.fillColor,stroke:this.strokeColor,originX:"center",originY:"center",selectable:!1,evented:!1}),0!==this.currentPath.width&&0!==this.currentPath.height&&e.add(this.currentPath),2===s&&(this._pathString="M ")}onMouseMove(t){if(!this.isMouseDown)return;let e=this._canvas;var s=e.getPointer(t.e);this.currentLine.set({x2:s.x,y2:s.y}),this.currentLine.setCoords(),e.renderAll()}onMouseUp(t){this.isMouseDown=!0}onMouseOut(t){this.isMouseDown=!1}onMouseDoubleClick(t){let e=this._canvas;for(let s=0;s<3;s++){let t=this._pathString.lastIndexOf("L");-1===t?(this._pathString="M ",e.remove(this.startCircle)):this._pathString=this._pathString.slice(0,t)}e.remove(this.currentLine),e.remove(this.currentPath),this.currentPath=new c.fabric.Path(this._pathString,{strokeWidth:this.strokeWidth,fill:this.fillColor,stroke:this.strokeColor,originX:"center",originY:"center",selectable:!1,evented:!1}),e.add(this.currentPath)}};var O=class extends p{constructor(){super(...arguments),this.isMouseDown=!1,this.fillColor="#ffffff",this.strokeWidth=10,this.strokeColor="#ffffff",this.currentRect=new c.fabric.Rect,this.currentStartX=0,this.currentStartY=0,this._minLength=10}configureCanvas(t){let{strokeWidth:e,strokeColor:s,fillColor:i}=t;return this._canvas.isDrawingMode=!1,this._canvas.selection=!1,this._canvas.forEachObject((t=>t.selectable=t.evented=!1)),this.strokeWidth=e,this.strokeColor=s,this.fillColor=i,this._minLength=e,this._canvas.on("mouse:down",(t=>this.onMouseDown(t))),this._canvas.on("mouse:move",(t=>this.onMouseMove(t))),this._canvas.on("mouse:up",(t=>this.onMouseUp(t))),this._canvas.on("mouse:out",(t=>this.onMouseOut(t))),()=>{this._canvas.off("mouse:down"),this._canvas.off("mouse:move"),this._canvas.off("mouse:up"),this._canvas.off("mouse:out")}}onMouseDown(t){let e=this._canvas,s=t.e.button;this.isMouseDown=!0;let i=e.getPointer(t.e);this.currentStartX=i.x,this.currentStartY=i.y,this.currentRect=new c.fabric.Rect({left:this.currentStartX,top:this.currentStartY,originX:"left",originY:"top",width:this._minLength,height:this._minLength,stroke:this.strokeColor,strokeWidth:this.strokeWidth,fill:this.fillColor,transparentCorners:!1,selectable:!1,evented:!1,strokeUniform:!0,noScaleCache:!1,angle:0}),0===s&&e.add(this.currentRect)}onMouseMove(t){if(!this.isMouseDown)return;let e=this._canvas,s=e.getPointer(t.e);this.currentStartX>s.x&&this.currentRect.set({left:Math.abs(s.x)}),this.currentStartY>s.y&&this.currentRect.set({top:Math.abs(s.y)});let i=Math.abs(this.currentStartX-s.x),o=Math.abs(this.currentStartY-s.y);this.currentRect.set({width:Math.max(i,2*this._minLength),height:Math.max(o,2*this._minLength)}),this.currentRect.setCoords(),e.renderAll()}onMouseUp(t){this.isMouseDown=!1}onMouseOut(t){this.isMouseDown=!1}};var R=class extends p{configureCanvas(t){let e=this._canvas;e.isDrawingMode=!1,e.selection=!0,e.forEachObject((t=>t.selectable=t.evented=!0));const s=()=>{let t=e.getActiveObject();null!=t&&e.remove(t)};return e.on("mouse:dblclick",s),()=>{e.off("mouse:dblclick",s)}}};var E=class extends p{constructor(){super(...arguments),this.isMouseDown=!1,this.fillColor="#ffffff",this.strokeWidth=10,this.strokeColor="#ffffff",this.currentCircle=new c.fabric.Circle,this.currentStartX=0,this.currentStartY=0,this.displayRadius=1}configureCanvas(t){let{strokeWidth:e,strokeColor:s,fillColor:i,displayRadius:o}=t;return this._canvas.isDrawingMode=!1,this._canvas.selection=!1,this._canvas.forEachObject((t=>t.selectable=t.evented=!1)),this.strokeWidth=e,this.strokeColor=s,this.fillColor=i,this.displayRadius=o,this._canvas.on("mouse:down",(t=>this.onMouseDown(t))),this._canvas.on("mouse:move",(t=>this.onMouseMove(t))),this._canvas.on("mouse:up",(t=>this.onMouseUp(t))),this._canvas.on("mouse:out",(t=>this.onMouseOut(t))),()=>{this._canvas.off("mouse:down"),this._canvas.off("mouse:move"),this._canvas.off("mouse:up"),this._canvas.off("mouse:out")}}onMouseDown(t){let e=this._canvas,s=t.e.button;this.isMouseDown=!0;let i=e.getPointer(t.e);this.currentStartX=i.x-(this.displayRadius+this.strokeWidth/2),this.currentStartY=i.y,this.currentCircle=new c.fabric.Circle({left:this.currentStartX,top:this.currentStartY,originX:"left",originY:"center",strokeWidth:this.strokeWidth,stroke:this.strokeColor,fill:this.fillColor,selectable:!1,evented:!1,radius:this.displayRadius}),0===s&&e.add(this.currentCircle)}onMouseMove(t){if(!this.isMouseDown)return;let e=this._canvas;this.currentCircle.setCoords(),e.renderAll()}onMouseUp(t){this.isMouseDown=!1}onMouseOut(t){this.isMouseDown=!1}};const W={circle:y,freedraw:A,line:x,polygon:D,rect:O,transform:R,point:E};function L(){const t=new URLSearchParams(window.location.search).get("streamlitUrl");if(null==t)return null;try{return new URL(t).origin}catch{return null}}var j=Object(r.b)((t=>{let{args:e}=t;const{canvasWidth:s,canvasHeight:a,backgroundColor:n,backgroundImageURL:h,realtimeUpdateStreamlit:u,drawingMode:d,fillColor:f,strokeWidth:m,strokeColor:k,displayRadius:b,initialDrawing:g,displayToolbar:C}=e,[w,_]=Object(i.useState)(new c.fabric.Canvas(""));w.stopContextMenu=!0,w.fireRightClick=!0;const[p,y]=Object(i.useState)(new c.fabric.StaticCanvas("")),{canvasState:{action:{shouldReloadCanvas:A,forceSendToStreamlit:x},currentState:D,initialState:O},saveState:R,undo:E,redo:j,canUndo:U,canRedo:X,forceStreamlitUpdate:T,resetState:P}=Object(i.useContext)(M);return Object(i.useEffect)((()=>{const t=new c.fabric.Canvas("canvas",{enableRetinaScaling:!1}),e=new c.fabric.StaticCanvas("backgroundimage-canvas",{enableRetinaScaling:!1});_(t),y(e),r.a.setFrameHeight()}),[]),Object(i.useEffect)((()=>{Object(l.isEqual)(O,g)||w.loadFromJSON(g,(()=>{w.renderAll(),P(g)}))}),[w,g,O,P]),Object(i.useEffect)((()=>{if(h){var t,e=new Image;e.onload=function(){p.getContext().drawImage(e,0,0)};const s=null!==(t=L())&&void 0!==t?t:"";e.src=s+h}}),[w,p,a,s,n,h,R]),Object(i.useEffect)((()=>{A&&w.loadFromJSON(D,(()=>{}))}),[w,A,D]),w.on("mouse:wheel",(function(t){var e=t.e.deltaY,s=w.getZoom();s=Math.min(20,Math.max(1,s*.9996**e)),w.zoomToPoint({x:t.e.offsetX,y:t.e.offsetY},s);var i=w.viewportTransform;if(i){var o=w.getWidth()*s,a=w.getHeight()*s,n=i[4],r=i[5],c=n+o,l=r+a,h=0,u=0;n>0&&(h=-n),r>0&&(u=-r),c<w.getWidth()&&(h=w.getWidth()-c),l<w.getHeight()&&(u=w.getHeight()-l),i[4]+=h,i[5]+=u,w.requestRenderAll()}t.e.preventDefault(),t.e.stopPropagation()})),Object(i.useEffect)((()=>{if(h){var t;const e=null!==(t=L())&&void 0!==t?t:"";c.fabric.Image.fromURL(e+h,(function(t){var e,s;w.setBackgroundImage(t,w.renderAll.bind(w),{scaleX:w.getWidth()/(null!==(e=t.width)&&void 0!==e?e:1),scaleY:w.getHeight()/(null!==(s=t.height)&&void 0!==s?s:1)})}))}}),[h,w]),Object(i.useEffect)((()=>{const t=new W[d](w).configureCanvas({fillColor:f,strokeWidth:m,strokeColor:k,displayRadius:b});return w.on("mouse:up",(t=>{R(w.toJSON()),3===t.button&&T()})),w.on("mouse:dblclick",(()=>{R(w.toJSON())})),()=>{t(),w.off("mouse:up"),w.off("mouse:dblclick")}}),[w,m,k,b,f,d,g,R,T]),o.a.createElement("div",{style:{position:"relative"}},o.a.createElement("div",{style:{position:"absolute",top:0,left:0,zIndex:-10,visibility:"hidden"}},o.a.createElement(S,{canvasHeight:a,canvasWidth:s,shouldSendToStreamlit:u||x,stateToSendToStreamlit:D})),o.a.createElement("div",{style:{position:"absolute",top:0,left:0,zIndex:0}},o.a.createElement("canvas",{id:"backgroundimage-canvas",width:s,height:a})),o.a.createElement("div",{style:{position:"absolute",top:0,left:0,zIndex:10}},o.a.createElement("canvas",{id:"canvas",width:s,height:a,style:{border:"transparant"}})),C&&o.a.createElement(v,{topPosition:a,leftPosition:s,canUndo:U,canRedo:X,downloadCallback:T,undoCallback:E,redoCallback:j,resetCallback:()=>{P(O)}}))}));s(23);n.a.render(o.a.createElement(o.a.StrictMode,null,o.a.createElement(_,null,o.a.createElement(j,null))),document.getElementById("root"))},4:function(t,e,s){t.exports={enabled:"CanvasToolbar_enabled__2bOtL",disabled:"CanvasToolbar_disabled__T9sX8",invertx:"CanvasToolbar_invertx__2gc2O"}}},[[24,1,2]]]);
//# sourceMappingURL=main.fd11c7ff.chunk.js.map